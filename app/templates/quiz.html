{% extends 'base.html' %}

{% block content %}
{% if request.user.is_authenticated %}

<div id="app" class="container mt-5 pt-5">
    <div class="col-md-6 mx-auto">
        <div class="card" v-if="!quizSubmitted">
            <div class="card-body">
                <h3 class="card-title text-center">{{ quiz_title }}</h3>
                <form @submit.prevent="submitQuiz">
                    <!-- Loop through questions -->
                    <div v-for="question in questions" :key="question.uid" class="mt-4">
                        <div class="card">
                            <div class="card-body">
                                <p class="card-text">[[question.question]]</p>
                                <!-- Loop through answers -->
                                <div class="form-check" v-for="(answer, index) in question.answers" :key="index">
                                    <!-- Radio button for selecting an answer -->
                                    <input
                                        v-model="userAnswers[question.uid]"
                                        :value="answer.answer"
                                        class="form-check-input"
                                        :id="'answer-' + question.uid + '-' + index"
                                        :name="'question-' + question.uid"
                                        type="radio">
                                    <label class="form-check-label" :for="'answer-' + question.uid + '-' + index">
                                        [[answer.answer]]
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 text-center">
                        <button type="submit" class="btn btn-primary">Submit Quiz</button>
                    </div>
                </form>
            </div>
            
        </div>
        <div class="card" style="margin-top: 30px;">
        </div>

        <div class="card" v-if="quizSubmitted">
            <div class="card-body">
                <h3 class="card-title text-center">Quiz Results</h3>
                <div v-for="(answer, questionUid) in userAnswers" :key="questionUid">
                    <p>Question: [[questionsMap[questionUid].question]]</p>
                    <p>Your Answer: [[answer]]</p>
                    <p v-if="answer === questionsMap[questionUid].correct_answer">Correct</p>
                    <p v-else>Incorrect</p>
                </div>
            </div>
    </div>
    <div class="card" style="margin-top: 30px;">
    </div>
</div>

<script src="https://unpkg.com/vue@3.0.0-rc.5/dist/vue.global.prod.js"></script>
<script>
    Vue.createApp({
        delimiters: ['[[', ']]'],
        data() {
            return {
                category: '{{ category }}',
                questions: [],
                userAnswers: {},
                quizSubmitted: false,
                questionsMap: {}
            };
        },
        methods: {
            getQuestions() {
                fetch(`/quiz/api/get-quiz/?category=${this.category}`)
                    .then(response => response.json())
                    .then(result => {
                        this.questions = result.data;
                        // Create a map for easier access
                        this.questionsMap = this.questions.reduce((map, question) => {
                            map[question.uid] = question;
                            return map;
                        }, {});
                    })
                    .catch(error => {
                        console.error('Error fetching questions:', error);
                    });
            },
            submitQuiz() {
                if (this.areAllQuestionsAnswered()) {
                    this.quizSubmitted = true;
                } else {
                    alert('Please answer all questions before submitting the quiz.');
                }
            },
            areAllQuestionsAnswered() {
                return this.questions.every(question => 
                    this.userAnswers.hasOwnProperty(question.uid));
            }
        },
        created() {
            this.getQuestions();
        }
    }).mount('#app');
</script>

{% else %}
<div class="text-center h3" style="margin-top: 70px;">Please log in to access the quiz.</div>
{% endif %}
{% endblock %}
